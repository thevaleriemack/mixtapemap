<!DOCTYPE html>
<html>
    <head>
        <!--  Please note Bootstrap is only used solely for the grid and table layouts.  -->
        <title>5100 Masters Capstone - Created by Denay Mack (dgm97)</title>
        <link rel="stylesheet/less" type="text/css" href="assets/stylesheets/main.less" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous"/>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.7.2/less.min.js"></script>
        <script src="https://connect.soundcloud.com/sdk/sdk-3.1.2.js"></script>
        <script src="data.js"></script>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>Mix Tape Map</h1>
                <h2>5100 Masters Capstone</h2>
                <ul>
                    <li>About</li>
                </ul>
            </header>
            <div class="row">
                <div class="col-lg-2">
                    <div id="search">
                        <form id="searchForm">
                            <input type="text" id="query" value="" placeholder="Type an Artist Name"/>
                            <button type="button" id="searchButton">Start</button>
                        </form>
                        <ul id="searchResults">
                        </ul>
                    </div>
                </div>
                <div class="col-lg-8">
                    <svg id="visualization">
                    </svg>            
                    <!-- <table class="table">
                        <thead>
                            <tr>
                              <th>#</th>
                              <th>Song</th>
                              <th>Artist</th>
                              <th>Play</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">1</th>
                                <td>Redemption Song</td>
                                <td>Bob Marley</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table> -->
                </div>
                <div class="col-lg-2"></div>
            </div>
        </div>
        <script>
            var artist;
            var firstNode;
            var lastArtistSong = [];
            var similarSongs = [];
            
            //**** get artist ****//
            function showSearchResults(res) {
                $("#searchResults").children().remove();
                res.forEach(function(sr) {
                    $("#searchResults").append("<li id='"+sr.id+"' class='searchResult'>"+sr.name+"</li>");
                })
            }
            var searchArtist = function(query) {
                console.log('user searched for '+query);
                $.ajax({
                    url: 'https://api.spotify.com/v1/search',
                    data: {
                        q: query,
                        type: 'artist',
                        limit: 5
                    },
                    success: function (response) {
                        showSearchResults(response.artists.items);
                    }
                });
            }
            $("#searchButton").click(function() {
                searchArtist($('#query').val());
            });
//            var getArtistSong = function(artistId) {
//                $.ajax({
//                    url: 'https://api.spotify.com/v1/artists/'+artistId+'/top-tracks',
//                    data: {
//                        country: 'US'
//                    },
//                    success: function (response) {
//                        var target = getRandomIntInclusive(0,9);
//                        lastArtistSong.pop();
//                        lastArtistSong.push(response.tracks[target]);
//                    }
//                });
//            }
//            var getSimilarSongs = function(artistId) {
//                $.ajax({
//                    url: 'https://api.spotify.com/v1/artists/'+artistId+'/related-artists',
//                    success: function (response) {
//                        similarSongs = [];
//                        var output = response.artists;
//                        for (var i=0; i<5; i++) {
//                            var target = getRandomIntInclusive(0,output.length-1);
//                            similarSongs.push(output[target]);
//                            output.splice(target, 1);
//                        }
//                    }
//                });
//            }
            //**** get song ****//
            $(document).on('click', '.searchResult', function () {
                // simulation begins once user selects artist
                console.log("user selected "+this.id);
                artist = this;
                $("#search").remove();
                
//                getArtistSong(artist.id);
//                firstNode = lastArtistSong[0];
//                start_nodes.push(firstNode);
                
//                getSimilarSongs(artist.id)
//                childNodes = similarSongs;
//                start_nodes.push(childNodes);
                
                showMap(start_nodes);
            });
            /*************************
            ********* app.js *********
            **************************/
            
            var width = 700;
            var height = 700;
            
            var svg = d3.select("#visualization")
            .attr("width", width)
            .attr("height", height);
            
            var force = d3.forceSimulation() 
            .force("charge", d3.forceManyBody().strength(-80).distanceMin(100).distanceMax(1000)) 
            .force("link", d3.forceLink().distance(100).id(function(d) { return d.index }).iterations(10)) 
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("y", d3.forceY(0.1))
            .force("x", d3.forceX(0.1))
            .alphaTarget(1);
            
            var start_nodes = [];
            var selected_nodes = [];
            
            function updateMap(n) {
                // add new selection
                n.group = "red";
                selected_nodes.push(n);
                // check for subnodes
                if (!n.subnodes) {
                    $("#shareables").css("display")
                } else {
                    new_nodes = [n];
                    new_nodes[0].subnodes.forEach(function(d) {
                        new_nodes.push(d);
                    });
                    svg.selectAll("*").remove();
                    
                    showMap(new_nodes);
                }
            }
            
            function showMap(nodes) {
                
                // add links
                var links = [];
                for (var i = 1; i < nodes.length; i++) {
                    links.push({"source":0, "target": i})
                }
                // start force
                force.nodes(nodes).force("link").links(links);
                
                // place links underneath
                var link = svg.selectAll(".link")
                .data(links)
                .enter()
                .append("line")
                .attr("class", "link");
                
                var legacy = svg.selectAll(".node").data(selected_nodes).enter().append("g");
                legacy.append("circle")
                .attr("r", 13)
                .attr('fill', "#ccc")
                .on("mouseover", showData)
                .on("mouseout", hideData);
                
                legacy.append("text")
                .attr("dx", 30)
                .attr("dy", 5)
                .style("font-family", "sans-serif")
                .style("font-size", "18px")
                .attr("fill", "#777")
                .text(function (d) {
                    return d.name
                });
                
                // place nodes
                var node = svg.selectAll(".node").data(nodes).enter().append("g");
                
                node.append('circle')
                .attr("class", "node")
                .attr('r', 13)
                .attr('fill', function (d) {
                    return d.group;
                })
                .on("mouseover", showData)
                .on("mouseout", hideData)
                .on("click", function(d) {
                    console.log(d);
                    if (d==nodes[0]) {
                        $("#errorMsg").html("That song is already on your list :) Click a new song to add.");
                    } else {
                        updateMap(d);
                    }
                });
            
                node.append("text")
                .attr("dx", 30)
                .attr("dy", 5)
                .style("font-family", "sans-serif")
                .style("font-size", "18px")
                .attr("fill", "black")
                .text(function (d) {
                    return d.name
                });
                
                force.on("tick", function() {
                    link.attr("x1", function (d) { return d.source.x; })
                    .attr("y1", function (d) { return d.source.y; })
                    .attr("x2", function (d) { return d.target.x; })
                    .attr("y2", function (d) { return d.target.y;
                    });
                    node.attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    });
                    legacy.attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    });
                });
            }
            
            d3.json("songs.json", function (error, json) {
                if (error) throw error;
                // add nodes
                start_nodes = json.nodes;
                start_nodes[0].subnodes.forEach(function(n) { start_nodes.push(n); });
                selected_nodes.push(start_nodes[0]);
            });
            
            function showData() {
                return;
            }
            function hideData() {
                return;
            }
        </script>
    </body>
</html>